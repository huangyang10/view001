<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶å‘³ - å®¶åº­é£Ÿè°±ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 480px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            min-height: 600px;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .back-btn {
            position: absolute;
            left: 15px;
            top: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn {
            position: absolute;
            right: 15px;
            top: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Content Area */
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-success {
            background: #2ed573;
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            width: auto;
            margin: 5px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #f0f0f0;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .card-content {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
        }

        .card-meta {
            display: flex;
            gap: 10px;
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            background: white;
            border-bottom: 3px solid #667eea;
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .dashboard-card:hover {
            transform: scale(1.05);
        }

        .dashboard-card .number {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }

        .dashboard-card .label {
            font-size: 12px;
            opacity: 0.9;
        }

        /* List Items */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            background: white;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item-content {
            flex: 1;
        }

        .list-item-title {
            font-weight: 600;
            color: #333;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .list-item-subtitle {
            font-size: 13px;
            color: #888;
        }

        .list-item-actions {
            display: flex;
            gap: 5px;
        }

        /* Status Badge */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-pending { background: #ffd32a; color: #333; }
        .badge-ready { background: #2ed573; color: white; }
        .badge-done { background: #a4b0be; color: white; }

        /* Loading & Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        /* Hidden/Show Pages */
        .page {
            display: none;
            animation: fadeIn 0.3s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            display: none;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* Calendar */
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin: 15px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .calendar-day:hover {
            background: #667eea;
            color: white;
        }

        .calendar-day.selected {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        /* Recipe Selector */
        .recipe-selector {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .recipe-option {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .recipe-option:hover {
            background: #f8f9fa;
        }

        .recipe-option.selected {
            background: #e8f0fe;
            border-left: 4px solid #667eea;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 25px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .container {
                border-radius: 0;
                min-height: 100vh;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .mt-10 { margin-top: 10px; }
        .mb-10 { margin-bottom: 10px; }
        .flex { display: flex; gap: 10px; }
        .hidden { display: none !important; }
        .text-danger { color: #ff4757; }
        .text-success { color: #2ed573; }
        .text-muted { color: #888; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- MODALS -->

    <!-- Add Recipe Modal -->
    <div id="recipeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ·»åŠ /ç¼–è¾‘èœè°±</div>
            <div class="form-group">
                <label>èœè°±åç§°</label>
                <input type="text" id="recipeName" placeholder="å¦‚ï¼šçº¢çƒ§è‚‰">
            </div>
            <div class="form-group">
                <label>åˆ†ç±»</label>
                <select id="recipeCategory">
                    <option value="æ—©é¤">æ—©é¤</option>
                    <option value="åˆé¤">åˆé¤</option>
                    <option value="æ™šé¤">æ™šé¤</option>
                    <option value="ç”œå“">ç”œå“</option>
                </select>
            </div>
            <div class="form-group">
                <label>é£Ÿæï¼ˆæ ¼å¼ï¼šåç§°:æ•°é‡:å•ä½ï¼Œæ¯è¡Œä¸€ä¸ªï¼‰</label>
                <textarea id="recipeIngredients" placeholder="å¦‚ï¼š&#10;äº”èŠ±è‚‰:500:g&#10;é…±æ²¹:30:ml"></textarea>
            </div>
            <div class="form-group">
                <label>çƒ¹é¥ªæ­¥éª¤ï¼ˆæ¯è¡Œä¸€ä¸ªæ­¥éª¤ï¼‰</label>
                <textarea id="recipeSteps" placeholder="å¦‚ï¼š&#10;1. åˆ‡è‚‰&#10;2. ç‚’ç³–è‰²"></textarea>
            </div>
            <div class="form-group">
                <label>çƒ¹é¥ªæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                <input type="number" id="recipeTime" placeholder="60">
            </div>
            <div class="form-group">
                <label>éš¾åº¦</label>
                <select id="recipeDifficulty">
                    <option value="ç®€å•">ç®€å•</option>
                    <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                    <option value="å›°éš¾">å›°éš¾</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRecipeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveRecipe()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ä»Šæ—¥ç‚¹é¤</div>

            <div class="form-group">
                <label>é€‰æ‹©æ—¥æœŸ</label>
                <input type="date" id="orderDate">
            </div>

            <div class="form-group">
                <label>é¤æ¬¡</label>
                <select id="orderType">
                    <option value="æ—©é¤">æ—©é¤</option>
                    <option value="åˆé¤">åˆé¤</option>
                    <option value="æ™šé¤">æ™šé¤</option>
                </select>
            </div>

            <div class="form-group">
                <label>é€‰æ‹©èœè°±</label>
                <div id="recipeSelector" class="recipe-selector"></div>
            </div>

            <div class="form-group">
                <label>å¤‡æ³¨</label>
                <input type="text" id="orderNotes" placeholder="å¦‚ï¼šå°‘æ²¹ã€å°‘ç›">
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeOrderModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="submitOrder()">æäº¤è®¢å•</button>
            </div>
        </div>
    </div>

    <!-- PAGE: Login -->
    <div id="loginPage" class="page active">
        <div class="header">
            <h1>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶å‘³</h1>
            <p>å®¶åº­é£Ÿè°±ä¸ç‚¹é¤ç®¡ç†</p>
        </div>
        <div class="content">
            <div class="tabs">
                <div class="tab active" onclick="switchAuthTab('login')">ç™»å½•</div>
                <div class="tab" onclick="switchAuthTab('register')">æ³¨å†Œ</div>
            </div>

            <div id="loginForm">
                <div class="form-group mt-10">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <button class="btn btn-primary" onclick="login()">ç™»å½•</button>
                <p class="text-center text-muted mt-10">æç¤ºï¼šé¦–æ¬¡ä½¿ç”¨è¯·æ³¨å†Œè´¦å·</p>
            </div>

            <div id="registerForm" class="hidden">
                <div class="form-group mt-10">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="regUsername" placeholder="è®¾ç½®ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="regPassword" placeholder="è®¾ç½®å¯†ç ">
                </div>
                <div class="form-group">
                    <label>è§’è‰²</label>
                    <select id="regRole">
                        <option value="admin">ç®¡ç†å‘˜ï¼ˆåˆ›å»ºå®¶åº­ï¼‰</option>
                        <option value="member">å®¶åº­æˆå‘˜</option>
                    </select>
                </div>
                <div class="form-group" id="familyNameGroup">
                    <label>å®¶åº­åç§°</label>
                    <input type="text" id="regFamilyName" placeholder="å¦‚ï¼šç‹å®¶">
                </div>
                <div class="form-group hidden" id="inviteCodeGroup">
                    <label>é‚€è¯·ç ï¼ˆåŠ å…¥å®¶åº­ï¼‰</label>
                    <input type="text" id="regInviteCode" placeholder="è¾“å…¥é‚€è¯·ç ">
                </div>
                <button class="btn btn-primary" onclick="register()">æ³¨å†Œ</button>
            </div>
        </div>
    </div>

    <!-- PAGE: Dashboard -->
    <div id="dashboardPage" class="page">
        <div class="header">
            <h1 id="familyName">å®¶åº­ä¸»é¡µ</h1>
            <p id="userName">æ¬¢è¿å›æ¥</p>
            <button class="logout-btn" onclick="logout()">é€€å‡º</button>
        </div>
        <div class="content">
            <div class="dashboard-grid">
                <div class="dashboard-card" onclick="showPage('recipesPage')">
                    <div>ğŸ“š</div>
                    <div class="number" id="recipeCount">0</div>
                    <div class="label">èœè°±æ€»æ•°</div>
                </div>
                <div class="dashboard-card" onclick="showPage('ordersPage')">
                    <div>ğŸ½ï¸</div>
                    <div class="number" id="orderCount">0</div>
                    <div class="label">ä»Šæ—¥è®¢å•</div>
                </div>
                <div class="dashboard-card" onclick="showPage('recipesPage')">
                    <div>â•</div>
                    <div class="number">æ·»åŠ </div>
                    <div class="label">æ–°èœè°±</div>
                </div>
                <div class="dashboard-card" onclick="openOrderModal()">
                    <div>ğŸ“‹</div>
                    <div class="number">ç‚¹é¤</div>
                    <div class="label">ä»Šæ—¥ç‚¹é¤</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ  é‚€è¯·å®¶åº­æˆå‘˜</div>
                <div class="card-content">
                    <p>é‚€è¯·ç ï¼š<strong id="inviteCodeDisplay">-</strong></p>
                    <p class="text-muted">åˆ†äº«é‚€è¯·ç ç»™å®¶äººï¼Œè®©ä»–ä»¬åŠ å…¥</p>
                    <button class="btn btn-secondary btn-small" onclick="copyInviteCode()">å¤åˆ¶é‚€è¯·ç </button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">â° ä»Šæ—¥æ¦‚è§ˆ</div>
                <div class="card-content" id="todayOverview">
                    æš‚æ— ä»Šæ—¥è®¢å•
                </div>
            </div>

            <div class="flex">
                <button class="btn btn-secondary" onclick="showPage('recipesPage')">ç®¡ç†èœè°±</button>
                <button class="btn btn-secondary" onclick="showPage('ordersPage')">æŸ¥çœ‹è®¢å•</button>
            </div>
        </div>
    </div>

    <!-- PAGE: Recipes -->
    <div id="recipesPage" class="page">
        <div class="header">
            <button class="back-btn" onclick="showPage('dashboardPage')">â†</button>
            <h1>ğŸ“š æˆ‘çš„èœè°±</h1>
            <button class="logout-btn" onclick="openRecipeModal()">+ æ–°å»º</button>
        </div>
        <div class="content">
            <div class="form-group">
                <input type="text" id="recipeSearch" placeholder="ğŸ” æœç´¢èœè°±..." oninput="filterRecipes()">
            </div>
            <div class="form-group">
                <select id="recipeFilter" onchange="filterRecipes()">
                    <option value="">å…¨éƒ¨åˆ†ç±»</option>
                    <option value="æ—©é¤">æ—©é¤</option>
                    <option value="åˆé¤">åˆé¤</option>
                    <option value="æ™šé¤">æ™šé¤</option>
                    <option value="ç”œå“">ç”œå“</option>
                </select>
            </div>
            <div id="recipeList"></div>
        </div>
    </div>

    <!-- PAGE: Orders -->
    <div id="ordersPage" class="page">
        <div class="header">
            <button class="back-btn" onclick="showPage('dashboardPage')">â†</button>
            <h1>ğŸ½ï¸ ç‚¹é¤è®¢å•</h1>
            <button class="logout-btn" onclick="openOrderModal()">+ ç‚¹é¤</button>
        </div>
        <div class="content">
            <div class="tabs">
                <div class="tab active" onclick="switchOrderTab('today')">ä»Šæ—¥</div>
                <div class="tab" onclick="switchOrderTab('history')">å†å²</div>
            </div>
            <div id="orderList" class="mt-10"></div>
        </div>
    </div>

</div>

<script>
// ==================== æ•°æ®å­˜å‚¨ä¸ç®¡ç† ====================

// ä½¿ç”¨localStorageæ¨¡æ‹Ÿåç«¯æ•°æ®åº“
const DB = {
    // è·å–å½“å‰ç”¨æˆ·
    getCurrentUser() {
        const user = localStorage.getItem('currentUser');
        return user ? JSON.parse(user) : null;
    },

    setCurrentUser(user) {
        localStorage.setItem('currentUser', JSON.stringify(user));
    },

    // ç”¨æˆ·ç®¡ç†
    saveUser(user) {
        const users = this.getUsers();
        users[user.username] = user;
        localStorage.setItem('users', JSON.stringify(users));
    },

    getUsers() {
        const data = localStorage.getItem('users');
        return data ? JSON.parse(data) : {};
    },

    // å®¶åº­ç®¡ç†
    saveFamily(family) {
        const families = this.getFamilies();
        families[family.id] = family;
        localStorage.setItem('families', JSON.stringify(families));
    },

    getFamilies() {
        const data = localStorage.getItem('families');
        return data ? JSON.parse(data) : {};
    },

    // èœè°±ç®¡ç†
    saveRecipe(recipe) {
        const recipes = this.getRecipes();
        recipe.id = recipe.id || Date.now().toString();
        recipe.familyId = this.getCurrentUser().familyId;
        recipes[recipe.id] = recipe;
        localStorage.setItem('recipes', JSON.stringify(recipes));
    },

    getRecipes() {
        const data = localStorage.getItem('recipes');
        const allRecipes = data ? JSON.parse(data) : {};
        const currentUser = this.getCurrentUser();
        if (!currentUser) return {};
        // åªè¿”å›å½“å‰å®¶åº­çš„èœè°±
        const familyRecipes = {};
        for (let id in allRecipes) {
            if (allRecipes[id].familyId === currentUser.familyId) {
                familyRecipes[id] = allRecipes[id];
            }
        }
        return familyRecipes;
    },

    deleteRecipe(id) {
        const recipes = this.getRecipes();
        delete recipes[id];
        localStorage.setItem('recipes', JSON.stringify(recipes));
    },

    // è®¢å•ç®¡ç†
    saveOrder(order) {
        const orders = this.getOrders();
        order.id = order.id || Date.now().toString();
        order.userId = this.getCurrentUser().id;
        order.familyId = this.getCurrentUser().familyId;
        order.status = 'pending';
        order.createdAt = new Date().toISOString();
        orders[order.id] = order;
        localStorage.setItem('orders', JSON.stringify(orders));
    },

    getOrders() {
        const data = localStorage.getItem('orders');
        const allOrders = data ? JSON.parse(data) : {};
        const currentUser = this.getCurrentUser();
        if (!currentUser) return {};
        // åªè¿”å›å½“å‰å®¶åº­çš„è®¢å•
        const familyOrders = {};
        for (let id in allOrders) {
            if (allOrders[id].familyId === currentUser.familyId) {
                familyOrders[id] = allOrders[id];
            }
        }
        return familyOrders;
    },

    // æ¸…ç©ºæ•°æ®ï¼ˆæµ‹è¯•ç”¨ï¼‰
    clearAll() {
        localStorage.clear();
    }
};

// ==================== UI æ§åˆ¶ ====================

function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');

    // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
    if (pageId === 'dashboardPage') {
        updateDashboard();
    } else if (pageId === 'recipesPage') {
        loadRecipes();
    } else if (pageId === 'ordersPage') {
        loadOrders('today');
    }
}

function showToast(message, duration = 2000) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.display = 'block';
    setTimeout(() => {
        toast.style.display = 'none';
    }, duration);
}

// ==================== è®¤è¯ç³»ç»Ÿ ====================

function switchAuthTab(tab) {
    const tabs = document.querySelectorAll('.tabs .tab');
    tabs.forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');

    if (tab === 'login') {
        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('registerForm').classList.add('hidden');
    } else {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('registerForm').classList.remove('hidden');
    }
}

// è§’è‰²åˆ‡æ¢æ—¶æ˜¾ç¤ºä¸åŒçš„å­—æ®µ
document.getElementById('regRole')?.addEventListener('change', function(e) {
    const familyGroup = document.getElementById('familyNameGroup');
    const inviteGroup = document.getElementById('inviteCodeGroup');

    if (e.target.value === 'admin') {
        familyGroup.classList.remove('hidden');
        inviteGroup.classList.add('hidden');
    } else {
        familyGroup.classList.add('hidden');
        inviteGroup.classList.remove('hidden');
    }
});

function login() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value.trim();

    if (!username || !password) {
        showToast('è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ');
        return;
    }

    const users = DB.getUsers();
    const user = users[username];

    if (user && user.password === password) {
        DB.setCurrentUser(user);
        showToast('ç™»å½•æˆåŠŸï¼');
        document.getElementById('userName').textContent = user.username;
        showPage('dashboardPage');
    } else {
        showToast('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
    }
}

function register() {
    const username = document.getElementById('regUsername').value.trim();
    const password = document.getElementById('regPassword').value.trim();
    const role = document.getElementById('regRole').value;
    const familyName = document.getElementById('regFamilyName').value.trim();
    const inviteCode = document.getElementById('regInviteCode').value.trim();

    if (!username || !password) {
        showToast('è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ');
        return;
    }

    const users = DB.getUsers();
    if (users[username]) {
        showToast('ç”¨æˆ·åå·²å­˜åœ¨');
        return;
    }

    const userId = Date.now().toString();
    let familyId, familyInviteCode;

    if (role === 'admin') {
        if (!familyName) {
            showToast('è¯·è¾“å…¥å®¶åº­åç§°');
            return;
        }
        familyId = Date.now().toString();
        familyInviteCode = Math.random().toString(36).substr(2, 8).toUpperCase();

        const family = {
            id: familyId,
            name: familyName,
            inviteCode: familyInviteCode,
            createdBy: userId,
            members: [userId]
        };
        DB.saveFamily(family);
    } else {
        if (!inviteCode) {
            showToast('è¯·è¾“å…¥é‚€è¯·ç ');
            return;
        }
        // æŸ¥æ‰¾å®¶åº­
        const families = DB.getFamilies();
        let foundFamily = null;
        for (let id in families) {
            if (families[id].inviteCode === inviteCode) {
                foundFamily = families[id];
                break;
            }
        }
        if (!foundFamily) {
            showToast('é‚€è¯·ç æ— æ•ˆ');
            return;
        }
        familyId = foundFamily.id;
        foundFamily.members.push(userId);
        DB.saveFamily(foundFamily);
    }

    const user = {
        id: userId,
        username,
        password,
        role,
        familyId,
        familyName: role === 'admin' ? familyName : null,
        inviteCode: role === 'admin' ? familyInviteCode : null
    };

    DB.saveUser(user);
    DB.setCurrentUser(user);

    showToast('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•');
    switchAuthTab('login');
    document.getElementById('loginUsername').value = username;
    document.getElementById('loginPassword').value = password;
}

function logout() {
    localStorage.removeItem('currentUser');
    showPage('loginPage');
    showToast('å·²é€€å‡ºç™»å½•');
}

// ==================== ä»ªè¡¨ç›˜ ====================

function updateDashboard() {
    const user = DB.getCurrentUser();
    if (!user) return;

    // æ˜¾ç¤ºå®¶åº­ä¿¡æ¯
    document.getElementById('familyName').textContent = user.familyName || 'æˆ‘çš„å®¶åº­';
    document.getElementById('userName').textContent = `æ¬¢è¿å›æ¥ï¼Œ${user.username}`;

    // æ˜¾ç¤ºé‚€è¯·ç 
    if (user.role === 'admin') {
        document.getElementById('inviteCodeDisplay').textContent = user.inviteCode;
    } else {
        const families = DB.getFamilies();
        const family = families[user.familyId];
        if (family) {
            document.getElementById('inviteCodeDisplay').textContent = family.inviteCode;
        }
    }

    // ç»Ÿè®¡æ•°æ®
    const recipes = DB.getRecipes();
    const orders = DB.getOrders();
    const today = new Date().toISOString().split('T')[0];

    const todayOrders = Object.values(orders).filter(o => o.orderDate === today);

    document.getElementById('recipeCount').textContent = Object.keys(recipes).length;
    document.getElementById('orderCount').textContent = todayOrders.length;

    // ä»Šæ—¥æ¦‚è§ˆ
    const overviewEl = document.getElementById('todayOverview');
    if (todayOrders.length === 0) {
        overviewEl.innerHTML = '<p class="text-muted">æš‚æ— ä»Šæ—¥è®¢å•</p>';
    } else {
        const html = todayOrders.map(o => `
            <div class="list-item">
                <div class="list-item-content">
                    <div class="list-item-title">${o.mealType} - ${o.recipeName}</div>
                    <div class="list-item-subtitle">${o.notes || 'æ— å¤‡æ³¨'}</div>
                </div>
                <span class="badge badge-${o.status === 'pending' ? 'pending' : o.status === 'ready' ? 'ready' : 'done'}">${o.status}</span>
            </div>
        `).join('');
        overviewEl.innerHTML = html;
    }
}

function copyInviteCode() {
    const code = document.getElementById('inviteCodeDisplay').textContent;
    navigator.clipboard.writeText(code).then(() => {
        showToast('é‚€è¯·ç å·²å¤åˆ¶');
    });
}

// ==================== èœè°±ç®¡ç† ====================

function openRecipeModal(recipeId = null) {
    const modal = document.getElementById('recipeModal');
    modal.classList.add('active');

    if (recipeId) {
        const recipes = DB.getRecipes();
        const recipe = recipes[recipeId];
        if (recipe) {
            document.getElementById('recipeName').value = recipe.name;
            document.getElementById('recipeCategory').value = recipe.category;
            document.getElementById('recipeIngredients').value = recipe.ingredients.map(i => `${i.name}:${i.amount}:${i.unit}`).join('\n');
            document.getElementById('recipeSteps').value = recipe.steps.join('\n');
            document.getElementById('recipeTime').value = recipe.cookTime;
            document.getElementById('recipeDifficulty').value = recipe.difficulty;
            modal.dataset.editId = recipeId;
        }
    } else {
        // æ¸…ç©ºè¡¨å•
        document.getElementById('recipeName').value = '';
        document.getElementById('recipeIngredients').value = '';
        document.getElementById('recipeSteps').value = '';
        document.getElementById('recipeTime').value = '';
        delete modal.dataset.editId;
    }
}

function closeRecipeModal() {
    document.getElementById('recipeModal').classList.remove('active');
}

function saveRecipe() {
    const name = document.getElementById('recipeName').value.trim();
    const category = document.getElementById('recipeCategory').value;
    const ingredientsText = document.getElementById('recipeIngredients').value.trim();
    const stepsText = document.getElementById('recipeSteps').value.trim();
    const cookTime = document.getElementById('recipeTime').value;
    const difficulty = document.getElementById('recipeDifficulty').value;

    if (!name || !ingredientsText || !stepsText) {
        showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
    }

    // è§£æé£Ÿæ
    const ingredients = ingredientsText.split('\n').map(line => {
        const [name, amount, unit] = line.split(':');
        return { name: name.trim(), amount: amount?.trim(), unit: unit?.trim() };
    }).filter(i => i.name);

    // è§£ææ­¥éª¤
    const steps = stepsText.split('\n').filter(s => s.trim());

    const recipe = {
        name,
        category,
        ingredients,
        steps,
        cookTime: cookTime || '0',
        difficulty
    };

    const modal = document.getElementById('recipeModal');
    if (modal.dataset.editId) {
        recipe.id = modal.dataset.editId;
    }

    DB.saveRecipe(recipe);
    closeRecipeModal();
    showToast('ä¿å­˜æˆåŠŸ');

    if (document.getElementById('recipesPage').classList.contains('active')) {
        loadRecipes();
    }
}

function loadRecipes() {
    const recipes = DB.getRecipes();
    const listEl = document.getElementById('recipeList');

    if (Object.keys(recipes).length === 0) {
        listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“–</div><p>æš‚æ— èœè°±ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ </p></div>';
        return;
    }

    const html = Object.values(recipes).map(recipe => `
        <div class="card">
            <div class="card-title">${recipe.name}</div>
            <div class="card-content">
                <p><strong>åˆ†ç±»ï¼š</strong>${recipe.category}</p>
                <p><strong>æ—¶é—´ï¼š</strong>${recipe.cookTime}åˆ†é’Ÿ | <strong>éš¾åº¦ï¼š</strong>${recipe.difficulty}</p>
                <p><strong>é£Ÿæï¼š</strong>${recipe.ingredients.map(i => i.name).join('ã€')}</p>
            </div>
            <div class="flex">
                <button class="btn btn-secondary btn-small" onclick="openRecipeModal('${recipe.id}')">ç¼–è¾‘</button>
                <button class="btn btn-danger btn-small" onclick="deleteRecipe('${recipe.id}')">åˆ é™¤</button>
            </div>
        </div>
    `).join('');

    listEl.innerHTML = html;
}

function deleteRecipe(id) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèœè°±å—ï¼Ÿ')) {
        DB.deleteRecipe(id);
        showToast('å·²åˆ é™¤');
        loadRecipes();
    }
}

function filterRecipes() {
    const search = document.getElementById('recipeSearch').value.toLowerCase();
    const filter = document.getElementById('recipeFilter').value;
    const recipes = DB.getRecipes();

    const filtered = Object.values(recipes).filter(r => {
        const matchSearch = !search || r.name.toLowerCase().includes(search) ||
                           r.ingredients.some(i => i.name.toLowerCase().includes(search));
        const matchFilter = !filter || r.category === filter;
        return matchSearch && matchFilter;
    });

    const listEl = document.getElementById('recipeList');
    if (filtered.length === 0) {
        listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”</div><p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„èœè°±</p></div>';
        return;
    }

    const html = filtered.map(recipe => `
        <div class="card">
            <div class="card-title">${recipe.name}</div>
            <div class="card-content">
                <p><strong>åˆ†ç±»ï¼š</strong>${recipe.category}</p>
                <p><strong>æ—¶é—´ï¼š</strong>${recipe.cookTime}åˆ†é’Ÿ | <strong>éš¾åº¦ï¼š</strong>${recipe.difficulty}</p>
                <p><strong>é£Ÿæï¼š</strong>${recipe.ingredients.map(i => i.name).join('ã€')}</p>
            </div>
            <div class="flex">
                <button class="btn btn-secondary btn-small" onclick="openRecipeModal('${recipe.id}')">ç¼–è¾‘</button>
                <button class="btn btn-danger btn-small" onclick="deleteRecipe('${recipe.id}')">åˆ é™¤</button>
            </div>
        </div>
    `).join('');

    listEl.innerHTML = html;
}

// ==================== ç‚¹é¤ç³»ç»Ÿ ====================

function openOrderModal() {
    const modal = document.getElementById('orderModal');
    modal.classList.add('active');

    // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
    document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];

    // åŠ è½½èœè°±åˆ—è¡¨
    loadRecipeSelector();
}

function closeOrderModal() {
    document.getElementById('orderModal').classList.remove('active');
}

function loadRecipeSelector() {
    const recipes = DB.getRecipes();
    const selector = document.getElementById('recipeSelector');

    if (Object.keys(recipes).length === 0) {
        selector.innerHTML = '<div class="empty-state" style="padding: 20px;"><p>æš‚æ— èœè°±ï¼Œè¯·å…ˆæ·»åŠ </p></div>';
        return;
    }

    const html = Object.values(recipes).map(recipe => `
        <div class="recipe-option" onclick="selectRecipe('${recipe.id}', this)">
            <div class="list-item-title">${recipe.name}</div>
            <div class="list-item-subtitle">${recipe.category} | ${recipe.cookTime}åˆ†é’Ÿ</div>
        </div>
    `).join('');

    selector.innerHTML = html;
}

let selectedRecipeId = null;

function selectRecipe(id, element) {
    document.querySelectorAll('.recipe-option').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    selectedRecipeId = id;
}

function submitOrder() {
    const orderDate = document.getElementById('orderDate').value;
    const orderType = document.getElementById('orderType').value;
    const notes = document.getElementById('orderNotes').value.trim();

    if (!orderDate) {
        showToast('è¯·é€‰æ‹©æ—¥æœŸ');
        return;
    }

    if (!selectedRecipeId) {
        showToast('è¯·é€‰æ‹©èœè°±');
        return;
    }

    const recipes = DB.getRecipes();
    const recipe = recipes[selectedRecipeId];

    const order = {
        recipeId: selectedRecipeId,
        recipeName: recipe.name,
        orderDate: orderDate,
        mealType: orderType,
        notes: notes
    };

    DB.saveOrder(order);
    closeOrderModal();
    showToast('ç‚¹é¤æˆåŠŸï¼');

    // é‡ç½®é€‰æ‹©
    selectedRecipeId = null;
    document.getElementById('orderNotes').value = '';

    if (document.getElementById('ordersPage').classList.contains('active')) {
        loadOrders('today');
    }

    updateDashboard();
}

function loadOrders(type = 'today') {
    const orders = DB.getOrders();
    const listEl = document.getElementById('orderList');

    let filteredOrders = Object.values(orders);
    const today = new Date().toISOString().split('T')[0];

    if (type === 'today') {
        filteredOrders = filteredOrders.filter(o => o.orderDate === today);
    } else {
        filteredOrders = filteredOrders.filter(o => o.orderDate < today);
    }

    // æŒ‰æ—¥æœŸå€’åº
    filteredOrders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

    if (filteredOrders.length === 0) {
        listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><p>æš‚æ— è®¢å•</p></div>';
        return;
    }

    const html = filteredOrders.map(order => `
        <div class="card">
            <div class="card-title">${order.orderDate} ${order.mealType}</div>
            <div class="card-content">
                <p><strong>èœè°±ï¼š</strong>${order.recipeName}</p>
                <p><strong>å¤‡æ³¨ï¼š</strong>${order.notes || 'æ— '}</p>
                <div class="card-meta">
                    <span>ä¸‹å•äººï¼š${order.userId === DB.getCurrentUser().id ? 'æˆ‘' : 'å®¶äºº'}</span>
                    <span class="badge badge-${order.status === 'pending' ? 'pending' : order.status === 'ready' ? 'ready' : 'done'}">${order.status}</span>
                </div>
            </div>
            ${order.status === 'pending' && order.userId === DB.getCurrentUser().id ? `
            <div class="flex">
                <button class="btn btn-success btn-small" onclick="changeOrderStatus('${order.id}', 'ready')">æ ‡è®°å‡†å¤‡å®Œæˆ</button>
                <button class="btn btn-secondary btn-small" onclick="changeOrderStatus('${order.id}', 'done')">æ ‡è®°å·²å®Œæˆ</button>
            </div>
            ` : ''}
        </div>
    `).join('');

    listEl.innerHTML = html;
}

function switchOrderTab(type) {
    const tabs = document.querySelectorAll('#ordersPage .tabs .tab');
    tabs.forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    loadOrders(type);
}

function changeOrderStatus(orderId, status) {
    const orders = DB.getOrders();
    if (orders[orderId]) {
        orders[orderId].status = status;
        localStorage.setItem('orders', JSON.stringify(orders));
        showToast('çŠ¶æ€å·²æ›´æ–°');
        loadOrders('today');
        updateDashboard();
    }
}

// ==================== åˆå§‹åŒ– ====================

window.onload = function() {
    // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
    const currentUser = DB.getCurrentUser();
    if (currentUser) {
        showPage('dashboardPage');
    } else {
        showPage('loginPage');
    }

    // æ¼”ç¤ºæ•°æ®ï¼ˆå¦‚æœä¸ºç©ºï¼‰
    if (Object.keys(DB.getUsers()).length === 0) {
        // åˆ›å»ºæ¼”ç¤ºç”¨æˆ·
        const demoUser = {
            id: 'demo1',
            username: 'demo',
            password: '123456',
            role: 'admin',
            familyId: 'demoFamily',
            familyName: 'æ¼”ç¤ºå®¶åº­',
            inviteCode: 'DEMO888'
        };

        const demoFamily = {
            id: 'demoFamily',
            name: 'æ¼”ç¤ºå®¶åº­',
            inviteCode: 'DEMO888',
            createdBy: 'demo1',
            members: ['demo1']
        };

        const demoRecipe = {
            id: 'demoRecipe1',
            name: 'è¥¿çº¢æŸ¿ç‚’é¸¡è›‹',
            category: 'åˆé¤',
            ingredients: [
                {name: 'è¥¿çº¢æŸ¿', amount: '2', unit: 'ä¸ª'},
                {name: 'é¸¡è›‹', amount: '3', unit: 'ä¸ª'}
            ],
            steps: ['è¥¿çº¢æŸ¿åˆ‡å—', 'é¸¡è›‹æ‰“æ•£', 'å…ˆç‚’é¸¡è›‹å†ç‚’è¥¿çº¢æŸ¿', 'æ··åˆç‚’åŒ€'],
            cookTime: '15',
            difficulty: 'ç®€å•',
            familyId: 'demoFamily'
        };

        const demoOrder = {
            id: 'demoOrder1',
            recipeId: 'demoRecipe1',
            recipeName: 'è¥¿çº¢æŸ¿ç‚’é¸¡è›‹',
            orderDate: new Date().toISOString().split('T')[0],
            mealType: 'åˆé¤',
            notes: 'å°‘æ²¹',
            status: 'pending',
            userId: 'demo1',
            familyId: 'demoFamily',
            createdAt: new Date().toISOString()
        };

        DB.saveUser(demoUser);
        DB.saveFamily(demoFamily);
        DB.saveRecipe(demoRecipe);
        DB.saveOrder(demoOrder);

        showToast('å·²åˆ›å»ºæ¼”ç¤ºè´¦å·ï¼šdemo / å¯†ç ï¼š123456', 3000);
    }
};
</script>

</body>
</html>
